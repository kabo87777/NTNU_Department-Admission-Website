stages:
  - dependencies
  - test
  - deploy

image: node:16

before_script:
  - npm install --location=global pnpm@7
  - pnpm config set store-dir .pnpm-store

default:
  cache: &cache
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - ./node_modules
    policy: pull

install dependencies:
  stage: dependencies
  interruptible: true
  cache:
    <<: *cache
    policy: push
  script:
    - pnpm install

test:
  stage: test
  needs:
    - job: install dependencies
      artifacts: false
  interruptible: true
  script:
    - pnpm lint
    - pnpm vue-tsc --noEmit
    - pnpm test

.vercel:
  stage: deploy
  needs:
    - job: install dependencies
      artifacts: false
  before_script:
    - npm install --location=global pnpm@7 vercel
    - pnpm config set store-dir .pnpm-store

deploy for preview:
  extends: .vercel
  except:
    - develop
    - main
  script:
    - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
    - vercel build --token=$VERCEL_TOKEN
    - vercel deploy --prebuilt --token=$VERCEL_TOKEN

deploy to staging:
  extends: .vercel
  only:
    - develop
  script:
    - vercel pull --yes --environment=development --token=$VERCEL_TOKEN
    - vercel build --token=$VERCEL_TOKEN
    - vercel deploy --prebuilt --token=$VERCEL_TOKEN
  environment:
    name: Staging
    url: https://admissions-frontend-staging.birkhoff.me

deploy to production:
  extends: .vercel
  only:
    - main
  script:
    - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
    - vercel build --token=$VERCEL_TOKEN
    - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
  environment:
    name: Production
    url: https://admissions.birkhoff.me
