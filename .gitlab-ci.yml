stages:
  - test
  - deploy

image: node:16

before_script:
  - npm install --location=global pnpm@7
  - pnpm config set store-dir .pnpm-store

default:
  cache: &cache
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - ./node_modules
    policy: pull

install dependencies:
  interruptible: true
  cache:
    <<: *cache
    policy: push
  script:
    - pnpm install

test:
  stage: test
  needs:
    - job: install dependencies
      artifacts: false
  interruptible: true
  script:
    - pnpm lint
    - pnpm vue-tsc --noEmit
    - pnpm test

.vercel:
  stage: deploy
  needs:
    - job: install dependencies
      artifacts: false
  before_script:
    - npm install --location=global pnpm@7 vercel
    - pnpm config set store-dir .pnpm-store

deploy for review:
  extends: .vercel
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event' # deploy for review for every MR.
  script:
    - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
    - vercel build --token=$VERCEL_TOKEN
    - exec 5>&1
    - VERCEL_DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token=$VERCEL_TOKEN | tee >(cat - >&5))
    - echo $VERCEL_DEPLOY_OUTPUT
    - >
      DEPLOY_URL=$($VERCEL_DEPLOY_OUTPUT | grep "Preview: " | awk '{print $2}')
    - echo "DYNAMIC_ENVIRONMENT_URL=$DEPLOY_URL" >> deploy.env
  artifacts:
    reports:
      dotenv: deploy.env
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: $DYNAMIC_ENVIRONMENT_URL

deploy to staging:
  extends: .vercel
  only:
    - develop
  script:
    - vercel pull --yes --environment=development --token=$VERCEL_TOKEN
    - vercel build --token=$VERCEL_TOKEN
    - vercel deploy --prebuilt --token=$VERCEL_TOKEN
  environment:
    name: Staging
    url: https://admissions-frontend-staging.birkhoff.me

deploy to production:
  extends: .vercel
  only:
    - main
  script:
    - vercel pull --yes --environment=production --token=$VERCEL_TOKEN
    - vercel build --token=$VERCEL_TOKEN
    - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
  environment:
    name: Production
    url: https://admissions.birkhoff.me
